from feather import read_dataframe as read_feather
import numpy as np
import pandas as pd
import pdb

from zpylib import data_path as dp
from zpylib import train_colnames
from zpylib.datatools import FeaturesByType

def refactor_col(infile, col):
    print(" ... " + col)
    series = read_feather(infile, columns=[col])[col]
    if col in PREDCOLS:
        metadata = pd.read_csv(dp("metadata/" + col)).drop('counts', axis=1)
        if col in FeaturesByType.categorical:
            df = pd.DataFrame({col: series})
            df['order'] = range(df.shape[0])
            df = df.merge(metadata, how='left').sort_values('order')
            newcol = 'new_' + col
            series = df[newcol].fillna(metadata.shape[0])
            values = series.astype(np.int64).values # Lightgbm treats this as missing for categorical features
        elif metadata[col].dtype.name in ['int64', 'float64']:
            values = series.values
        else:
            pdb.set_trace()
    else:
        values = series.values
    return values

def refactor(infile, outfile, expected_columns):
    print("### Loading " + infile)
    df = pd.DataFrame({col: refactor_col(infile, col) for col in expected_columns})
    df.to_feather(outfile)

# Constants
ALLCOLS = pd.read_csv(dp('raw/train.csv'), nrows=2).columns.tolist()
ALLCOLS_EXCEPT_RESPONSE = [a for a in ALLCOLS if a != 'HasDetections']
PREDCOLS = train_colnames()

# Main
refactor(dp("raw/train.feather"), dp("refactored/train.feather"), ALLCOLS)
refactor(dp("raw/test.feather"), dp("refactored/test.feather"), ALLCOLS_EXCEPT_RESPONSE)