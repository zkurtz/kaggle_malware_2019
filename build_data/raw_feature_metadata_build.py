from distutils.version import LooseVersion
from feather import read_dataframe as read_feather
import pandas as pd

from zpylib import data_path as dp
from zpylib import datatools
from zpylib import train_colnames

def build_version_index(series):
    name = series.name
    values = series.unique().tolist()
    values.sort(key=LooseVersion)
    return pd.DataFrame({name: values, 'new_'+name: range(len(values))})

def load_features(col):
    return read_feather(dp('raw/train.feather'), columns=[col])

def make_metadata(col):
    print("Beginning column " + col)
    newcol = 'new_'+col
    X = load_features(col)
    series = X[col]
    md = pd.DataFrame(series.value_counts(dropna=False))
    md['counts'] = md[col]
    md[col] = md.index
    if col in VERSION_COLS:
        idx_df = build_version_index(series)
        md = md.merge(idx_df, how='left')
        md.sort_values(newcol, inplace=True)
    else:
        md[newcol] = range(md.shape[0])
    md.to_csv(dp('metadata/' + col), index=False)

# Constants
PREDCOLS = train_colnames()
VERSION_COLS = datatools.identify_version_features()
[make_metadata(col) for col in PREDCOLS]