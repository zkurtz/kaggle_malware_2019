import pandas as pd
import pdb

from zpylib import datatools
from zpylib.learn.gbm import Lgbm
from zpylib import data_path as dp
from zpylib import metadata

def train_one_gbm(data, cat=False):
    lgb = Lgbm(verbose=True, declare_categoricals=cat)
    lgb.train(data)
    return lgb

# data = datatools.data_from_feather(dp('refactored/train_split_0.feather'))
# lgb1 = train_one_gbm(data, cat=False)
# lgb2 = train_one_gbm(data, cat=True)
# lgb1.importance().head(10)
# lgb2.importance().head(10)
#
# # Identify categoricals that also appear important as continuous features
# df = lgb1.importance()
# important_continuous = set(df[df.gain > 1000].feature.tolist())
# catcont = list(set(data.coltypes.categorical).intersection(important_continuous))
# # Of these, leave as categorical those with fewer than four distinct values
# mdf = metadata.build_refactored_metadata()
# mdf = mdf[mdf.is_categorical==1]
# mdf = mdf[mdf['nunique'] > 3]
# mycatcont = list(set(catcont).intersection(set(mdf.colname.tolist())))
# "['" + "', '".join(mycatcont) + "']"
# pd.read_csv(dp('metadata/AVProductStatesIdentifier'))

def filter_categoricals_on_nunique(cols, lb=4):
    mdf = metadata.build_refactored_metadata()
    mdf = mdf[mdf.is_categorical==1]
    mdf = mdf[mdf['nunique'] > 3]
    okcols = mdf.colname.tolist()
    return list(set(cols).intersection(set(okcols)))

dtypes = datatools.FeaturesByType()
df = datatools.read_feather(dp('refactored/train_split_0.feather'))
data = datatools.Data(df, select = dtypes.categorical)
lgb = train_one_gbm(data, cat=True)
top_categoricals=lgb.importance().head(10).feature.tolist()
filter_categoricals_on_nunique(top_categoricals)
pdb.set_trace()

pd.read_csv(dp('metadata/SmartScreen'))

