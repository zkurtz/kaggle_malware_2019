import numpy as np
import pandas as pd
import pdb
import sqlite3

from . import constants

def add_index(conn, table, variable):
    command = ''.join(["CREATE INDEX index_", table,
                       "_", variable,
                       " ON ", table,
                       " (", variable,
                       ");"])
    conn.cursor().execute(command)

class DatabaseHandle(object):
    def __init__(self, path = constants.db_path, seed=None):
        self.conn = sqlite3.connect(path)
        self.path = path # debug
        self.seed = seed

    def query(self, sql):
        return pd.read_sql(sql, self.conn)

    def sql(self, command):
        return self.conn.cursor().execute(command).fetchall()

    def n_random_machines(self, n):
        np.random.seed(self.seed)
        ids = self.query('SELECT DISTINCT MachineIdentifier FROM data WHERE is_train = True'
                         )['MachineIdentifier'].tolist()
        assert len(ids) >= n
        return np.random.choice(ids, size=n, replace=False)

    def n_random_test_and_train_machines(self):
        ''' Randomly select 2*n machines, and return half of them as train and half of them as test '''
        ids = self.n_random_machines(2*n)
        return ids[:n], ids[n:]
